<!doctype html>
<html lang="de-CH">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Erfassen – Geordnete Wildheit</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root{--brand:#84B414;--ink:#1a1a1a;--muted:#5d5d5d;--border:#dde3d6;--paper:#fff;--bg:#f6f8f5;--radius:12px;--shadow:0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.08);--maxw:980px}
    *{box-sizing:border-box}
    body{margin:0;font:400 17px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:1rem}
    h1{font-size:1.35rem;margin:.25rem 0}
    h2{font-size:1.1rem;margin:1.25rem 0 .5rem 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width:880px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    label{display:block;font-weight:600;margin:.5rem 0 .25rem 0}
    input[type="text"], input[type="date"], textarea, select{width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .help{color:var(--muted);font-size:.92rem}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
    button{appearance:none;border:1px solid #cfd7c5;background:#fff;border-radius:999px;padding:.6rem .95rem;cursor:pointer;font-weight:650;box-shadow:var(--shadow)}
    button.primary{background:var(--brand);color:#fff;border-color:transparent}
    pre{white-space:pre-wrap;word-break:break-word;background:#fbfcfa;border:1px solid var(--border);border-radius:10px;padding:.75rem;font-size:.95rem}
    .preview{display:grid;gap:.4rem}
    .labels{display:flex;gap:.5rem;flex-wrap:wrap}
    .label{font-size:.78rem;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--border);background:#fff;color:#333}
    .label.bereich{background:#f1f7ea}
    .label.region{background:#f4f6f8}
    .label.date{background:#fff;color:#666}
    .ok{color:#246b00}
    .warn{color:#8a4b00}
    .err{color:#9d0015}
    .hr{height:1px;background:var(--border);margin:.75rem 0}
    .gate{position:fixed;inset:0;background:rgba(246,248,245,.96);display:flex;align-items:center;justify-content:center;z-index:1000}
    .gate .panel{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:1rem;max-width:420px;width:92%}
    .status{padding:.4rem .6rem;border-radius:8px;border:1px solid var(--border);display:inline-block;margin-top:.5rem}
    .json-head{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .iconbtn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.35rem .55rem;cursor:pointer}
    .iconbtn svg{width:18px;height:18px;flex:0 0 18px}
  </style>
</head>
<body>
  <div id="gate" class="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="panel">
      <h2 id="gateTitle">Zutritt</h2>
      <p class="help">Bitte die Passphrase eingeben.</p>
      <label for="pw">Passphrase</label>
      <input id="pw" type="password" autocomplete="current-password" inputmode="text" />
      <div class="actions">
        <button class="primary" id="gateOpen">Öffnen</button>
      </div>
      <p id="gateMsg" class="help"></p>
    </div>
  </div>

  <header>
    <div class="wrap">
      <h1>Erfassungsmaske für neue Karte</h1>
      <p class="help">Die Seite lädt die aktuelle <code>assets/content.json</code>, ergänzt deinen Eintrag und bietet die fertige Datei zum Download oder Kopieren an.</p>
      <div id="loadStatus" class="status">Lade content.json …</div>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <div class="grid">
      <section class="card" aria-label="Eingabe">
        <h2>Eingabe</h2>

        <label for="title">Titel *</label>
        <input id="title" type="text" placeholder="z. B. Velorouten in Brugg sicher machen" required>

        <div class="row">
          <div>
            <label for="theme">Bereich *</label>
            <select id="theme" required></select>
          </div>
          <div>
            <label for="region">Region/Ort *</label>
            <input id="region" type="text" placeholder="z. B. Brugg, Kanton Bern" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="date">Datum (Veröffentlichung) *</label>
            <input id="date" type="date" required>
            <div id="dateHuman" class="help"></div>
          </div>
          <div>
            <label for="image">Bild-Datei (Pfad) </label>
            <input id="image" type="text" placeholder="assets/images/dateiname.jpg oder nur dateiname.jpg">
            <div class="help">Dateiname allein genügt; wird automatisch zu <code>assets/images/&lt;datei&gt;</code>.</div>
          </div>
        </div>

        <label for="alt">Bild-Alttext</label>
        <input id="alt" type="text" placeholder="Was ist auf dem Bild zu sehen?">

        <label for="text">Kurztext *</label>
        <textarea id="text" placeholder="2–3 Sätze, klar und konkret." required></textarea>

        <label for="next">Nächster Schritt *</label>
        <textarea id="next" placeholder="Was passiert als Nächstes?" required></textarea>

        <div class="row" style="align-items:center">
          <div>
            <label><input id="featured" type="checkbox"> Als Top-Beitrag (featured) anzeigen</label>
            <div class="help">Wird oben neben dem Porträt als „Featured“ gezeigt.</div>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnPreview">Eintrag erzeugen</button>
          <button id="btnDownloadCard" disabled>Nur Eintrag als JSON</button>
          <button id="btnDownloadContent" disabled>content.json aktualisiert</button>
          <button id="btnCopyMerged" disabled>Kopieren: ganze content.json</button>
          <button id="btnReset" type="button">Zurücksetzen</button>
        </div>

        <p id="msg" class="help"></p>
        <div class="hr"></div>

        <h2>Optional: content.json lokal einlesen</h2>
        <div>
          <input id="file" type="file" accept="application/json" />
          <p class="help">Falls der Live-Abruf blockiert ist, kannst du hier eine lokale <code>content.json</code> wählen. Sie wird als Basis verwendet.</p>
        </div>
      </section>

      <section class="card" aria-label="Vorschau und Ergebnis">
        <h2>Vorschau</h2>
        <div id="preview" class="preview">
          <p class="help">Noch kein Eintrag erzeugt.</p>
        </div>

        <div class="json-head">
          <h2 style="margin:0">JSON-Eintrag</h2>
          <button id="btnCopy" class="iconbtn" aria-label="JSON-Eintrag kopieren" title="JSON kopieren" disabled>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg>
            Kopieren
          </button>
        </div>
        <pre id="out">{}</pre>
      </section>
    </div>

    <section class="card" style="margin-top:1rem">
      <h2>Ablauf</h2>
      <ol>
        <li>„Eintrag erzeugen“ klicken.</li>
        <li><strong>content.json aktualisiert</strong> downloaden oder „Kopieren: ganze content.json“ nutzen.</li>
        <li>Datei im Repo unter <code>assets/content.json</code> ersetzen.</li>
        <li>Falls ein Bildpfad gesetzt ist: Bild nach <code>assets/images/</code> hochladen.</li>
        <li>Seite hart neu laden: Cmd-Shift-R.</li>
      </ol>
      <p class="help">Alte Einträge bleiben erhalten. Der neue Eintrag wird oben ergänzt. Dubletten (gleiche <code>id</code> oder gleicher Titel+Datum) werden verhindert.</p>
    </section>
  </main>

  <script>
    // Türchen
    const PASSPHRASE = "brugg";
    const gate = document.getElementById('gate');
    const gateMsg = document.getElementById('gateMsg');
    document.getElementById('gateOpen').addEventListener('click', ()=>{
      const v = (document.getElementById('pw').value||"").trim();
      if(v===PASSPHRASE){ sessionStorage.setItem('erfassen-ok','1'); gate.remove(); }
      else { gateMsg.textContent = "Passphrase falsch."; }
    });
    if(sessionStorage.getItem('erfassen-ok')==='1'){ gate.remove(); }

    // Helfer
    const $ = s => document.querySelector(s);
    const statusEl = document.getElementById('loadStatus');
    function setStatus(text, cls){ statusEl.textContent=text; statusEl.className='status '+(cls||''); }
    function slugify(s){ return (s||"").toLowerCase()
      .replace(/ä/g,"ae").replace(/ö/g,"oe").replace(/ü/g,"ue").replace(/é|è/g,"e")
      .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80); }
    const IMG_EXT=['png','jpg','jpeg','webp','avif','gif'];
    function hasValidExt(p){ const m=/\.([a-z0-9]{3,4})$/i.exec(p||""); return !!(m && IMG_EXT.includes(m[1].toLowerCase())); }
    function isFilename(p){ return /^[^\\/]+\.([a-z0-9]{3,4})$/i.test(p||""); }
    function normaliseImagePath(p){
      if(!p) return "";
      let v=p.trim();
      if(!hasValidExt(v)) return "";
      if(v.startsWith('assets/images/')) return v;
      if(isFilename(v)) return 'assets/images/'+v;
      return "";
    }
    function download(filename, text){
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json;charset=utf-8'}));
      a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    }

    // content.json laden
    let CONTENT=null;
    async function fetchLiveContent(){
      const res=await fetch('../assets/content.json',{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    (async function init(){
      try{
        CONTENT=await fetchLiveContent();
        setStatus('content.json geladen ✓','ok');
      }catch(e){
        setStatus('content.json konnte nicht live geladen werden. Du kannst unten eine lokale Datei wählen.','warn');
        CONTENT={themes:["Bildung","Verkehr","Energie","Gleichstellung","Digitalisierung","Lokales"],status:["Entwurf","In Arbeit","beschlossen"],agenda:[],transparency:[],cards:[]};
      }
      const sel=$("#theme"); sel.innerHTML='<option value="">– bitte wählen –</option>';
      (CONTENT.themes||[]).forEach(t=>{ const o=document.createElement('option'); o.textContent=t; sel.appendChild(o); });
    })();

    // Lokale Datei
    $("#file").addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const txt=await f.text();
        CONTENT=JSON.parse(txt);
        setStatus('Lokale content.json geladen ✓','ok');
        const sel=$("#theme"); sel.innerHTML='<option value="">– bitte wählen –</option>';
        (CONTENT.themes||[]).forEach(t=>{ const o=document.createElement('option'); o.textContent=t; sel.appendChild(o); });
      }catch(err){ setStatus('Lokale Datei konnte nicht gelesen werden.','err'); }
    });

    // UI
    $("#date").addEventListener("input", e=>{
      const v=e.target.value;
      if(!v){ $("#dateHuman").textContent=""; return; }
      const [Y,M,D]=v.split("-").map(Number);
      const d=new Date(Y,(M||1)-1,(D||1));
      const fmt=new Intl.DateTimeFormat('de-CH',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      let s=fmt.format(d); s=s.charAt(0).toUpperCase()+s.slice(1);
      $("#dateHuman").textContent="→ "+s;
    });

    function buildObject(){
      const title=$("#title").value.trim();
      const theme=$("#theme").value.trim();
      const region=$("#region").value.trim();
      const date=$("#date").value;
      const mediaRaw=$("#image").value.trim();
      const media=normaliseImagePath(mediaRaw);
      const alt=$("#alt").value.trim();
      const text=$("#text").value.trim();
      const next=$("#next").value.trim();
      const featured = $("#featured").checked;

      const errors=[];
      if(!title) errors.push("Titel fehlt");
      if(!theme) errors.push("Bereich fehlt");
      if(!region) errors.push("Region fehlt");
      if(!date) errors.push("Datum fehlt");
      if(!text) errors.push("Kurztext fehlt");
      if(!next) errors.push("Nächster Schritt fehlt");
      if(mediaRaw && !media) errors.push("Bildpfad ungültig (z. B. assets/images/bild.jpg oder nur bild.jpg)");

      const id="c-"+slugify(title)+"-"+date.replaceAll("-","");
      const obj={id,title,theme,region,date,text,next};
      if(media) obj.media=media;
      if(alt) obj.alt=alt;
      if(featured) obj.featured=true;
      return {ok:errors.length===0, errors, obj};
    }

    function renderPreview(c){
      const prev=$("#preview"); prev.innerHTML="";
      const labels=document.createElement("div"); labels.className="labels";
      const L=(t,cls="")=>{ const s=document.createElement("span"); s.className="label "+cls; s.textContent=t; return s; };
      labels.append(L(c.theme,"bereich"), L(c.region,"region"));
      const fmt=new Intl.DateTimeFormat('de-CH',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      let s=fmt.format(new Date(c.date)); s=s.charAt(0).toUpperCase()+s.slice(1);
      labels.append(L(s,"date"));
      const h3=document.createElement("h3"); h3.textContent=c.title;
      const p1=document.createElement("p"); p1.textContent=c.text;
      const p2=document.createElement("p"); p2.innerHTML="<strong>Nächster Schritt:</strong> "+(c.next||"–");
      if(c.featured) prev.append(document.createTextNode("Top-Beitrag (featured)"));
      prev.append(h3,labels,p1,p2);
    }

    function mergedContent(newObj){
      const base = CONTENT ? JSON.parse(JSON.stringify(CONTENT)) : {themes:[],status:[],agenda:[],transparency:[],cards:[]};
      base.cards = base.cards || [];
      // Dubletten vermeiden
      base.cards = base.cards.filter(c => !(c.id===newObj.id || (c.title===newObj.title && c.date===newObj.date)));
      base.cards.unshift(newObj);
      return base;
    }

    // Aktionen
    $("#btnPreview").addEventListener("click", ()=>{
      const res=buildObject();
      const msg=$("#msg");
      if(!res.ok){ msg.textContent="Bitte korrigieren: "+res.errors.join(", ")+".";
        msg.className="err"; return; }
      msg.textContent="Alles plausibel."; msg.className="ok";
      $("#out").textContent=JSON.stringify(res.obj,null,2);
      $("#btnCopy").disabled=false;
      renderPreview(res.obj);

      $("#btnDownloadCard").disabled=false;
      $("#btnDownloadContent").disabled=false;
      $("#btnCopyMerged").disabled=false;

      $("#btnDownloadCard").onclick=()=>{
        const name=`card-${res.obj.date}-${slugify(res.obj.title)}.json`;
        download(name, JSON.stringify(res.obj,null,2));
      };
      $("#btnDownloadContent").onclick=()=>{
        const mc = mergedContent(res.obj);
        download("content.json", JSON.stringify(mc,null,2));
      };
      $("#btnCopy").onclick=async ()=>{
        try{
          await navigator.clipboard.writeText(JSON.stringify(res.obj,null,2));
          $("#btnCopy").textContent='Kopiert'; setTimeout(()=>{$("#btnCopy").textContent='Kopieren';},1200);
        }catch(e){ alert('Kopieren nicht erlaubt – bitte manuell markieren.'); }
      };
      $("#btnCopyMerged").onclick=async ()=>{
        try{
          const mc = mergedContent(res.obj);
          await navigator.clipboard.writeText(JSON.stringify(mc,null,2));
          $("#btnCopyMerged").textContent='Kopiert'; setTimeout(()=>{$("#btnCopyMerged").textContent='Kopieren: ganze content.json';},1200);
        }catch(e){ alert('Kopieren nicht erlaubt – bitte Download nutzen.'); }
      };
    });

    $("#btnReset").addEventListener("click", ()=>{
      document.querySelectorAll('input, textarea, select').forEach(el=>{ if(el.type!=='date') el.value=""; });
      $("#featured").checked=false;
      $("#date").value=""; $("#dateHuman").textContent="";
      $("#out").textContent="{}"; $("#preview").innerHTML='<p class="help">Noch kein Eintrag erzeugt.</p>';
      $("#msg").textContent=""; $("#btnDownloadCard").disabled=true; $("#btnDownloadContent").disabled=true; $("#btnCopy").disabled=true; $("#btnCopyMerged").disabled=true;
    });
  </script>
</body>
</html>
